# CRM MVP Implementation Plan

## Overview
Complete implementation plan for the CRM MVP based on the PRD requirements. This plan follows a **code reuse first** approach, extending existing files and patterns rather than creating new ones where possible.

## Code Reuse Strategy
**COMPLIANCE CONFIRMED**: This implementation prioritizes extending existing architecture over creating new files.

### Files to EXTEND (Not Create New):
- `server/actions/example.ts` → Modify for CRM actions  
- `server/queries/example.ts` → Modify for CRM queries
- `app/(dashboard)/dashboard/page.tsx` → Extend with CRM features
- `test/auth-flow.test.ts` → Extend pattern for CRM tests

### Files to REUSE:
- All existing `components/ui/*` shadcn/ui components
- Authentication patterns from `server/actions/auth.ts`
- Layout patterns from `app/(dashboard)/layout.tsx`
- RLS and trigger patterns from existing profiles migration

## Implementation Phases

### Phase 1: Database Schema & Migrations (Tasks 1-5)
- [ ] **EXTEND**: Create single migration following `20250531113526_create_profiles_table.sql` pattern
- [ ] **REUSE**: RLS policies structure from profiles table
- [ ] **REUSE**: Trigger patterns and security functions from profiles 
- [ ] **REUSE**: Same UUID and timestamp patterns as profiles
- [ ] Run database reset and regenerate TypeScript types

### Phase 2: Server Actions & Queries (Tasks 6-11)
- [ ] **EXTEND**: `server/actions/example.ts` → Rename to `contacts.ts`
- [ ] **EXTEND**: `server/actions/example.ts` → Rename to `deals.ts` 
- [ ] **EXTEND**: `server/actions/example.ts` → Rename to `activities.ts`
- [ ] **EXTEND**: `server/queries/example.ts` → Rename to `contacts.ts`
- [ ] **EXTEND**: `server/queries/example.ts` → Rename to `deals.ts`
- [ ] **REUSE**: Error handling patterns from `auth.ts`

### Phase 3: UI Components (Tasks 12-17)
- [ ] **REUSE**: Existing shadcn/ui components (Card, Button, Form, Dialog)
- [ ] **EXTEND**: Create CRM forms using existing Form patterns
- [ ] **REUSE**: Card layouts from existing dashboard
- [ ] **NEW**: Drag-and-drop deal cards (justified: no existing drag-drop)
- [ ] **REUSE**: Modal patterns from existing components
- [ ] **EXTEND**: Activity components using existing Card structure

### Phase 4: Main Pages & Features (Tasks 18-21)
- [ ] **EXTEND**: `app/(dashboard)/dashboard/page.tsx` with CRM overview
- [ ] **NEW**: `/contacts` page (justified: new route required)
- [ ] **NEW**: `/pipeline` page (justified: new route required)  
- [ ] **NEW**: Contact detail pages (justified: new route pattern)

### Phase 5: Advanced Features (Tasks 22-24)
- [ ] **EXTEND**: Add search to existing page structures
- [ ] **EXTEND**: Add filters using existing form patterns
- [ ] **REUSE**: Supabase subscription patterns if any exist

### Phase 6: Polish & Testing (Tasks 25-27)
- [ ] **REUSE**: Error handling patterns from auth
- [ ] **EXTEND**: Existing Zod validation approach
- [ ] **EXTEND**: `test/auth-flow.test.ts` pattern for CRM tests
- [ ] **REUSE**: Existing performance optimization approaches

## Database Schema Design

### Contacts Table
```sql
- id: UUID (primary key)
- user_id: UUID (foreign key to profiles)
- name: TEXT (required)
- email: TEXT
- phone: TEXT
- company: TEXT
- notes: TEXT
- created_at: TIMESTAMPTZ
- updated_at: TIMESTAMPTZ
```

### Deals Table
```sql
- id: UUID (primary key)
- user_id: UUID (foreign key to profiles)
- contact_id: UUID (foreign key to contacts)
- title: TEXT (required)
- description: TEXT
- value: DECIMAL
- stage: TEXT (foreign key to deal_stages.name)
- created_at: TIMESTAMPTZ
- updated_at: TIMESTAMPTZ
```

### Activities Table
```sql
- id: UUID (primary key)
- user_id: UUID (foreign key to profiles)
- contact_id: UUID (nullable, foreign key to contacts)
- deal_id: UUID (nullable, foreign key to deals)
- content: TEXT (required)
- type: TEXT (default: 'note')
- created_at: TIMESTAMPTZ
```

### Deal Stages Table
```sql
- id: UUID (primary key)
- user_id: UUID (foreign key to profiles)
- name: TEXT (required)
- order: INTEGER (for sorting)
- created_at: TIMESTAMPTZ
```

## Key Features

### Core CRM Functions
1. **Contacts Management** - Full CRUD with search and filtering
2. **Deal Pipeline** - Kanban board with drag-and-drop stage updates
3. **Activity Tracking** - Notes and interactions linked to contacts/deals
4. **Dashboard** - Overview with quick stats and recent activities

### Technical Implementation
- **Authentication** - Already implemented with Supabase Auth
- **Database** - PostgreSQL with Row Level Security
- **Frontend** - Next.js 15.3 with Server Components
- **UI** - shadcn/ui components with Tailwind CSS
- **State Management** - Server Actions + React state
- **Real-time** - Supabase subscriptions for live updates

## Success Criteria
- Users can manage contacts (create, edit, delete, search)
- Users can track deals through pipeline stages
- Users can log activities and notes
- Clean, responsive UI that works on desktop and mobile
- Fast performance (<300ms response times)
- Proper error handling and validation
- Basic test coverage for critical flows

This plan follows the PRD requirements exactly, building core CRM functionality while leveraging the existing Next.js + Supabase architecture.